# Plan 039: Refactor MapRender to Use Entities for Walls

## 1. Objective

The current implementation of `MapRender` in `@proj-tower/maprender` uses a separate, manually managed array (`wallSprites`) for rendering wall tiles. This is inconsistent with the `Entity` system used for all other dynamic objects.

The goal of this task is to refactor `MapRender` to use `Entity` objects for wall tiles (and any other tile marked as `isEntity: true`), thus unifying the rendering logic and eliminating the `wallSprites` array.

## 2. Task Decomposition

1.  **Modify `packages/maprender/src/map-render.ts`:**
    *   **Remove `wallSprites`:** Delete the `private wallSprites: Sprite[] = [];` property.
    *   **Introduce `mapEntities`:** Add a new `private mapEntities: Entity[] = [];` property. This will be used to track the static entities (like walls) that are generated by the `drawMap` method, allowing them to be cleaned up on a redraw without affecting externally managed entities (like the player or monsters).
    *   **Update Cleanup Logic:** In the `drawMap` method, replace the old loop that removes sprites from `wallSprites` with a new loop. This new loop will iterate over `this.mapEntities`, call `this.removeEntity(entity)` for each one, and then clear the `this.mapEntities` array.
    *   **Update Entity Creation Logic:** In the `drawMap` method's main loop, when a tile has `isEntity: true`:
        1.  Create a new `Entity` instance.
        2.  Create the `Sprite` for the tile texture and set its anchor to `(0.5, 1)`.
        3.  Add the `Sprite` as a child of the new `Entity`.
        4.  Set the `x`, `y`, and `zIndex` properties on the `Entity` instance itself.
        5.  Add the newly created entity to the renderer using `this.addEntity(entity)`.
        6.  Track this new entity by pushing it into the `this.mapEntities` array.

2.  **Verification:**
    *   Install dependencies with `pnpm install`.
    *   Run the game's development server using `pnpm dev`.
    *   Load the game in a browser and confirm that:
        *   Walls and other static entity tiles are rendered correctly.
        *   The player character correctly appears in front of or behind walls based on their relative Y-position (Z-ordering).
        *   There are no console errors.

3.  **Documentation:**
    *   Create a report file `jules/plan039-report.md` detailing the work done, challenges encountered, and the solution.
    *   Update the main project documentation `jules.md` to reflect the internal improvements to the `MapRender` class, noting that it now consistently uses the `Entity` system.
    *   Review `agents.md` to determine if any changes are necessary. (This is likely not needed as it's an internal refactor).
